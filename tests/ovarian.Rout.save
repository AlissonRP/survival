
R Under development (unstable) (2019-06-28 r76752) -- "Unsuffered Consequences"
Copyright (C) 2019 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> options(na.action=na.exclude) # preserve missings
> options(contrasts=c('contr.treatment', 'contr.poly')) #ensure constrast type
> library(survival)
> 
> #
> # Test the coxph program on the Ovarian data
> #
> fit <- coxph(Surv(futime, fustat) ~ age + ecog.ps + strata(rx), ovarian)
> summary(fit)
Call:
coxph(formula = Surv(futime, fustat) ~ age + ecog.ps + strata(rx), 
    data = ovarian)

  n= 26, number of events= 12 

            coef exp(coef) se(coef)      z Pr(>|z|)   
age      0.13853   1.14858  0.04801  2.885  0.00391 **
ecog.ps -0.09670   0.90783  0.62994 -0.154  0.87800   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
age        1.1486     0.8706    1.0454     1.262
ecog.ps    0.9078     1.1015    0.2641     3.120

Concordance= 0.819  (se = 0.058 )
Likelihood ratio test= 12.71  on 2 df,   p=0.002
Wald test            = 8.43  on 2 df,   p=0.01
Score (logrank) test = 12.24  on 2 df,   p=0.002

> summary(survfit(fit))
Call: survfit(formula = fit)

                rx=1 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
   59     13       1    0.978  0.0266       0.9275            1
  115     12       1    0.951  0.0478       0.8620            1
  156     11       1    0.910  0.0760       0.7722            1
  268     10       1    0.862  0.1055       0.6776            1
  329      9       1    0.737  0.1525       0.4909            1
  431      8       1    0.627  0.1704       0.3680            1
  638      5       1    0.333  0.2296       0.0865            1

                rx=2 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  353     13       1    0.943  0.0560        0.839        1.000
  365     12       1    0.880  0.0812        0.735        1.000
  464      9       1    0.789  0.1143        0.594        1.000
  475      8       1    0.697  0.1349        0.477        1.000
  563      7       1    0.597  0.1494        0.366        0.975

> sfit <- survfit(fit, list(age=c(30,70), ecog.ps=c(2,3)))  #two columns
> sfit
Call: survfit(formula = fit, newdata = list(age = c(30, 70), ecog.ps = c(2, 
    3)))

      n events median 0.95LCL 0.95UCL
rx=1 13      7     NA      NA      NA
rx=2 13      5     NA      NA      NA
rx=1 13      7    268     115      NA
rx=2 13      5    365     353      NA
> summary(sfit)
Call: survfit(formula = fit, newdata = list(age = c(30, 70), ecog.ps = c(2, 
    3)))

                rx=1 
 time n.risk n.event survival1 survival2
   59     13       1     0.999   0.87905
  115     12       1     0.999   0.74575
  156     11       1     0.998   0.57398
  268     10       1     0.996   0.41764
  329      9       1     0.992   0.16673
  431      8       1     0.988   0.06489
  638      5       1     0.973   0.00161

                rx=2 
 time n.risk n.event survival1 survival2
  353     13       1     0.999    0.7092
  365     12       1     0.997    0.4738
  464      9       1     0.994    0.2494
  475      8       1     0.991    0.1207
  563      7       1     0.987    0.0489

> 
> 
> # Check of offset + surv, added 7/2000
> fit1 <- coxph(Surv(futime, fustat) ~ age + rx, ovarian,
+ 	      control=coxph.control(eps=1e-8))
> fit2 <- coxph(Surv(futime, fustat) ~ age + offset(rx*fit1$coef[2]), ovarian,
+ 	      control=coxph.control(eps=1e-8))
> all.equal(fit1$coef[1], fit2$coef[1])
[1] TRUE
> 
> fit <- coxph(Surv(futime, fustat) ~ age + offset(rx), ovarian)
> survfit(fit, censor=FALSE)$surv^exp(-1.5)
 [1] 1.0000000 0.9977751 0.9951975 0.9917927 0.9881504 0.9825769 0.9770280
 [8] 0.9704304 0.9603196 0.9499085 0.9385539 0.9217097 0.9031334
> 
> # Check it by hand -- there are no tied times
> #  Remember that offsets from survfit are centered, which is 1.5 for
> #  this data set.
> eta <- fit$coef*(ovarian$age - fit$mean) + (ovarian$rx - 1.5)
> ord <- order(ovarian$futime)
> risk <- exp(eta[ord])
> rsum <- rev(cumsum(rev(risk)))   # cumulative risk at each time point
> dead <- (ovarian$fustat[ord]==1)
> baseline <- cumsum(1/rsum[dead])
> all.equal(survfit(fit, censor=FALSE)$surv, c(1, exp(-baseline)))
[1] TRUE
> 
> rm(fit, fit1, fit2, ord, eta, risk, rsum, dead, baseline, sfit)
> 
> proc.time()
   user  system elapsed 
  0.828   0.040   0.871 
